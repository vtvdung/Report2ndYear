---
title: "MSE"
author: "Dung Vu Tien Viet"
date: "31 octobre 2018"
output: html_document
---

## 1. General formula of MSE

One hospital is characterized by four parameters $(n_c, n_h, p_c, p_h)$ where

* $n_c$ is the number community-acquired infection samples;
* $n_h$ is the number of hospital-acquired infection samples;
* $p_c$ is the prevelance of resistance among community-acquired infections;
* $p_h$ is the prevalence of resistance among hospital-acquired infections.

Our aim is to find the best (in term of MSE) estimator $\hat{p_c}$ of $p_c$.

In absence of information on $n_c$, $n_h$ and $p_h$, the best estimator
of $p_c$ we can get is

$$
\hat{p_c} = \frac{n_c p_c + n_h p_h}{n_c + n_h} \ \ \  (1)
$$
By definition,

$$
\mbox{MSE}\left(\hat{p_c}\right) = \mbox{Var}\left(\hat{p_c}\right) + 
                                   \mbox{Bias}\left(\hat{p_c}\right)^2 =
                 \frac{\hat{p_c} \left(1 - \hat{p_c}\right)} {n_c + n_h} +
                 \left(\hat{p_c} - p_c\right)^2\ \ \ (2)
$$

which gives

$$
\mbox{MSE}\left(\hat{p_c}\right) =
\frac{(n_cp_c+n_hp_h)(n_cq_c+n_hq_h)}{(n_c+n_h)^3} +
\left(\frac{n_hp_h-n_hp_c}{n_c+n_h}\right)^2 \ \ \ (3)
$$
with $q_c = 1 - p_c$ and $q_h = 1 - p_h$.


*Simulation procedure*

For a fix value of sample size $n_c$ and $n_h$, I will create a figure two compare MSE obtained by formula and by simulation when $p_c$ and $p_h$ vary.

1. Set value for $p_c$, $p_h$, $n_c$ and $n_h$ 

2. calculate $MSE_f$ using (3).

3. For one simulation loop:

    1. generate two random population using $rbinom(n_c,1,p_c)$ and $rbinom(n_h,1,p_h)$ 

		2. Calculate overall resistance proportion $\left(\hat{p_c}\right)$ after merging two populations 
		
		3. Calculate square of difference bewteen overall resistance $\hat{p_c}$ and $p_c$ --> call $MSE_1$
		
		4. Calculate $MSE_2$, ... $MSE_{10000}$
		
		5. Calculate $MSE_{average} = \frac{\sum_{1 \leqslant i  \leqslant 10000}(MSE)}{10000}$ and compare with $MSE_ obtained by formula_f$

4. Redo from step 1 to step 3 with other value of $p_c$, $p_h$

5. Make a figure of $p_c$ on x axis, $p_h$ on y axis and two lines of $MSE_{average}$ and $MSE_f$

6. $n_c$ and $n_h$ are still constant. Should we choose only some values: 1000, 2000, 10000?
		
*End of simulation procedure*




Divise numerator and denominator of variance and bias by $n_h$


$$
variance = \frac{(\frac{n_c}{n_h}p_c+p_h)(\frac{n_c}{n_h}q_c+q_h)}{(n_c+n_h)(\frac{n_c}{n_h}+1)^2} \ \ \ (4)
$$


$$
bias=\left(\frac{p_h-p_c}{\frac{n_c}{n_h}+1}\right)^2 \ \ \ (5)
$$


$$
lim_{\frac{n_c}{n_h}\to\infty}(variance)=\frac{p_cp_h}{n_c+n_h} \ \ \ (6)
$$

$$
lim_{\frac{n_c}{n_h}\to 0}(variance)=\frac{q_cq_h}{n_c+n_h} \ \ \ (7)
$$


$$
lim_{\frac{n_c}{n_h}\to\infty}(bias) = 0 \ \ \ (8)
$$

$$
lim_{\frac{n_c}{n_h}\to 0}(bias) = (p_h-p_c)^2 \ \ \ (9)
$$

$p_h$ and $p_c$ are constant, so

from (4), (6) and (7) we conclude variance depends on ratio $\frac{n_c}{n_h}$ and value of $n_c,\ n_h$

from (5), (8) and (9) we see that bias depends on ratio $\frac{n_c}{n_h}$ and varies in range $[0, (p_h-p_c)^2]$

> how do you know??? You have to prove it!

In case of $k$ hospitals, each hospital is characterized by four parameters. We
suppose the resistance prevalence among CAI ($p_c$) remains constant in all 
hospitals. So the MSE will be represented by a set of parameters $(n_{c1},\dots,n_{ck},n_{h1},\dots,n_{hk},p_c,p_{h1},\dots,p_{hk},)$

$$
\hat{p_c} =\frac{\displaystyle\sum_{1 \leqslant i  \leqslant k}(n_{ci}p_c +n_{hi}p_{hi})}{\displaystyle\sum_{1 \leqslant i  \leqslant k}(n_{ci}+n_{hi})} \ \ \ (10)
$$

And

$$
\mbox{MSE}\left(\hat{p_c}\right) = \frac{\frac{\sum_{}(n_{ci}p_c +n_{hi}p_{hi})}{\sum_{}(n_{ci}+n_{hi})}\left(1-\frac{\sum_{}(n_{ci}p_c +n_{hi}p_{hi})}{\sum_{}(n_{ci}+n_{hi})}\right)}{\sum_{}(n_{ci}+n_{hi})}+\left(\frac{\sum_{}(n_{ci}p_c +n_{hi}p_{hi})}{\sum_{}(n_{ci}+n_{hi})}-p_c\right)^2  \ \ \ (11)
$$


which gives

$$
\mbox{MSE}\left(\hat{p_c}\right) = \frac{\sum_{}(n_{ci}p_c +n_{hi}p_{hi})\sum_{}(n_{ci}q_c +n_{hi}q_{hi})}{(\sum_{}n_{ci}+n_{hi})^3} + \left(\frac{\sum_{}n_{hi}(p_{hi}-p_c)}{\sum_{}(n_{ci}+n_{hi})}\right)^2  \ \ \ (12)
$$

> You need to validate this with simulations with 2 hospitals and 3 hospitals.

## 2. Variation of MSE

We continue to consider following cases:

+ One type of hospital with $t_1$ hospitals

+ Two types of hospital with $t_1$ and $t_2$ hospitals

+ Three types of hospital with $t_1$, $t_2$ and $t_3$ hospitals

Hospitals are considered as same type if they have same parameters.

### 2.1. One type of hospital

Given $t_1$ hospitals having $(n_c,n_h,p_c,p_h),\ q_c=1-p_c,\ q_h=1-p_h$.

$$
MSE=\frac{t_1(n_{c}p_c +n_{h}p_{h})t_1(n_{c}q_c +n_{h}q_{h})}
{(t_1(n_{c}+n_{h}))^3} +
\frac{(t_1(n_{h}(p_{h}-p_c)))^2}
{(t_1(n_{c}+n_{h}))^2}  \ \ \ (13)
$$



$$
MSE=\frac{(n_{c}p_c +n_{h}p_{h})(n_{c}q_c +n_{h}q_{h})}
{t_1(n_{c}+n_{h})^3} +
\frac{n_{h}^2(p_{h}-p_c)^2}
{(n_{c}+n_{h})^2}   \ \ \ (14)
$$


$p_h$ and $p_c$ are constant. Assign $r=\frac{n_c}{n_h}$ and $n=n_c+n_h$

The variation of bias $(\frac{n_{h}^2(p_{h}-p_c)^2}{(n_{c}+n_{h})^2})$ depends on $\frac{n_{h}}{(n_{c}+n_{h})}$ = $\frac{1}{(r+1)}$. $r$ is constant in one hospital (but we do not know the true value). So the bias is constant.

The variation of variance $\frac{(n_{c}p_c +n_{h}p_{h})(n_{c}q_c +n_{h}q_{h})}{t_1(n_{c}+n_{h})^3}$ depends on number of hospital $t_1$ and sample size in one hospital $n$. 


$$
variance=\frac{(rp_c +p_{h})(rq_c +q_{h})}{t_1n(r+1)^2}   \ \ \ (15)
$$

 Thus, the variance depends on number of hospital $t_1$ and sample size in one hospital $n$.

> All these formulas need to be validated with simulations! Same comments for the
next 2 sections

### 2.2. Two types of hospital

Given $t_1$ hospitals having $(n_{c1},n_{h1},p_c,p_{h1}),\ q_c=1-p_c,\ q_{h1}=1-p_{h1}$ and $t_2$ hospitals having $(n_{c2},n_{h2},p_c,p_{h2}),\ q_{h2}=1-p_{h2}$.

$$
MSE=\frac{(t_1(n_{c1}p_c +n_{h1}p_{h1})+t_2(n_{c2}p_c +n_{h2}p_{h2}))(t_1(n_{c1}q_c +n_{h1}q_{h1})+t_2(n_{c2}q_c +n_{h2}q_{h2}))}
{(t_1(n_{c1}+n_{h1})+t_2(n_{c2}+n_{h2}))^3} +
\frac{(t_1n_{h1}(p_{h1}-p_c)+t_2n_{h2}(p_{h2}-p_c))^2}
{(t_1(n_{c1}+n_{h1})+t_2(n_{c2}+n_{h2}))^2}   \ \ \ (16)
$$

### 2.3. Three types of hospital

Given $t_1$ hospitals having $(n_{c1},n_{h1},p_c,p_{h1}),\ q_c=1-p_c,\ q_{h1}=1-p_{h1}$, $t_2$ hospitals having $(n_{c2},n_{h2},p_c,p_{h2}),\ q_{h2}=1-p_{h2}$ and  $t_3$ hospitals having $(n_{c3},n_{h3},p_c,p_{h3}),\ q_{h3}=1-p_{h3}$.

$$
MSE=\frac{(t_1(n_{c1}p_c +n_{h1}p_{h1})+t_2(n_{c2}p_c +n_{h2}p_{h2})+t_3(n_{c3}p_c +n_{h3}p_{h3}))(t_1(n_{c1}q_c +n_{h1}q_{h1})+t_2(n_{c2}q_c +n_{h2}q_{h2}))+t_3(n_{c3}q_c +n_{h3}q_{h3}))}
{(t_1(n_{c1}+n_{h1})+t_2(n_{c2}+n_{h2})+t_3(n_{c3}+n_{h3}))^3} +
\frac{(t_1n_{h1}(p_{h1}-p_c)+t_2n_{h2}(p_{h2}-p_c)+t_3n_{h3}(p_{h3}-p_c))^2}
{(t_1(n_{c1}+n_{h1})+t_2(n_{c2}+n_{h2})+t_3(n_{c3}+n_{h3}))^2}   \ \ \ (17)
$$

### 2.4. Compare bias, variance and MSE between three cases

#### 2.4.1. One type vesus two types of hospital (same number of hospital)

We compare first surveillance system ($t_1+t_2$ hospitals of type 1) and second system ($t_1$ hospitals of type 1 and $t_2$ hospitals of type 2)

Bias comparison

$$
\Delta B=\frac{(t_1n_{h1}(p_{h1}-p_c)+t_2n_{h2}(p_{h2}-p_c))^2}{(t_1(n_{c1}+n_{h1})+t_2(n_{c2}+n_{h2}))^2}-
\frac{n_{h1}^2(p_{h1}-p_c)^2}{(n_{c1}+n_{h1})^2}   \ \ \ (18)
$$

Variance comparison

$$
\Delta V=\frac{(t_1(n_{c1}p_c +n_{h1}p_{h1})+t_2(n_{c2}p_c +n_{h2}p_{h2}))(t_1(n_{c1}q_c +n_{h1}q_{h1})+t_2(n_{c2}q_c +n_{h2}q_{h2}))}
{(t_1(n_{c1}+n_{h1})+t_2(n_{c2}+n_{h2}))^3}-
\frac{(n_{c1}p_c +n_{h1}p_{h1})(n_{c1}q_c +n_{h1}q_{h1})}
{(t_1+t_2)(n_{c1}+n_{h1})^3}   \ \ \ (19)
$$


How $\Delta B$ and $\Delta V$ vary in function of $t_1$ and $t_2$?

